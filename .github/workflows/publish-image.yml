
name: Publish Image

on:
  push: # push åˆ°ä¸»åˆ†æ”¯è‡ªåŠ¨ å‘å¸ƒ
    branches: ["master"]
    paths-ignore: # å¿½ç•¥ä¸€äº›ä¸å¿…è¦çš„æ–‡ä»¶
      - ".gitignore"
      - "README.md"
      - ".vscode/**"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_TOKEN }}
          submodules: true
      - run: |
          git submodule init
          git submodule update --remote      
      - uses: docker/login-action@v1
        with:
          registry: registry.cn-shanghai.aliyuncs.com # å£°æ˜é•œåƒæº
          username: ${{ secrets.ALIYUN_USER }} # å½“å‰github ç”¨æˆ·å
          password: ${{ secrets.ALIYUN_PWD }} # éœ€è¦å» https://github.com/settings/tokens ç”Ÿæˆä¸€ä¸ª åä¸º tokenï¼Œæ³¨æ„æ­¤token éœ€è¦è¯»å†™ packages ç­‰æƒé™
      - uses: actions/setup-node@v2
        with:
          node-version: "20.12.1"
      - name: Install and Build ğŸ”§
        run: |
          npm i
          npm run build

      - name: Show Dir
        run: ls

      - name: Build the  Docker image
        run:
          | # ä½¿ç”¨ ä¸Šä¸€æ­¥å†™çš„ Dockerfile æ„å»ºé•œåƒå¹¶å‘å¸ƒåˆ°ç§æœ‰ä»“åº“ï¼› å‘å¸ƒå®Œæˆå¯ä»¥å» https://github.com/songxingguo?tab=packages æŸ¥çœ‹
          docker build . --file Dockerfile --tag registry.cn-shanghai.aliyuncs.com/songxingguo/hi:latest
          docker push registry.cn-shanghai.aliyuncs.com/songxingguo/hi:latest
      - name: æ›´æ–°æœåŠ¡å™¨
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }} # æœåŠ¡å™¨ipåœ°å€ ; éœ€è¦å»ä»“åº“çš„ settings/secrets/actions å»åˆ›å»º
          username: ${{ secrets.SERVER_USER }} # æœåŠ¡å™¨ç”¨æˆ·åç§°ï¼›éœ€è¦å»ä»“åº“çš„ settings/secrets/actions å»åˆ›å»º
          password: ${{ secrets.SERVER_PWD }} # æœåŠ¡å™¨å¯†ç ï¼›éœ€è¦å»ä»“åº“çš„ settings/secrets/actions å»åˆ›å»º
          port: ${{ secrets.SERVER_PORT }} # æœåŠ¡å™¨ç«¯å£ï¼Œé»˜è®¤22ï¼›éœ€è¦å»ä»“åº“çš„ settings/secrets/actions å»åˆ›å»º
          script: | # é‡å¯æ›´æ–°é•œåƒ
            docker login --username=${{ secrets.ALIYUN_USER }} -p ${{ secrets.ALIYUN_PWD }} registry.cn-shanghai.aliyuncs.com
            docker pull registry.cn-shanghai.aliyuncs.com/songxingguo/hi:latest
            cd /root/deploy && ./deploy.sh
  